# Q1

## sem Ã­ndice

Limit  (cost=1621396.34..1621396.59 rows=100 width=22) (actual time=23817.369..23817.613 rows=100 loops=1)
  ->  Sort  (cost=1621396.34..1625128.08 rows=1492696 width=22) (actual time=23817.366..23817.596 rows=100 loops=1)
        Sort Key: (((count(DISTINCT questions.id) + count(DISTINCT answers.id)) + count(DISTINCT comments.id))) DESC
        Sort Method: top-N heapsort  Memory: 32kB
        ->  GroupAggregate  (cost=1375512.48..1564346.58 rows=1492696 width=22) (actual time=16223.379..23408.804 rows=1492696 loops=1)
              Group Key: u.id
              ->  Incremental Sort  (cost=1375512.48..1527029.18 rows=1492696 width=26) (actual time=16222.226..19033.946 rows=1838594 loops=1)
"                    Sort Key: u.id, questions.id"
                    Presorted Key: u.id
                    Full-sort Groups: 47995  Sort Method: quicksort  Average Memory: 28kB  Peak Memory: 28kB
                    Pre-sorted Groups: 10969  Sort Method: quicksort  Average Memory: 879kB  Peak Memory: 1155kB
                    ->  Merge Left Join  (cost=1375512.41..1459857.86 rows=1492696 width=26) (actual time=16221.674..18410.390 rows=1838594 loops=1)
                          Merge Cond: (u.id = comments.userid)
                          ->  Merge Left Join  (cost=923210.74..1002509.19 rows=1492696 width=22) (actual time=10920.517..12642.764 rows=1502367 loops=1)
                                Merge Cond: (u.id = answers.owneruserid)
                                ->  Merge Left Join  (cost=443920.15..519078.70 rows=1492696 width=18) (actual time=5350.024..6763.406 rows=1494696 loops=1)
                                      Merge Cond: (u.id = questions.owneruserid)
                                      ->  Index Scan using users_pkey on users u  (cost=0.43..71021.55 rows=1492696 width=14) (actual time=0.240..989.806 rows=1492696 loops=1)
                                      ->  Sort  (cost=443919.71..443988.80 rows=27638 width=12) (actual time=5349.773..5357.722 rows=27612 loops=1)
                                            Sort Key: questions.owneruserid
                                            Sort Method: quicksort  Memory: 1849kB
                                            ->  Gather  (cost=1000.00..441880.80 rows=27638 width=12) (actual time=2431.429..5336.434 rows=27665 loops=1)
                                                  Workers Planned: 2
                                                  Workers Launched: 2
                                                  ->  Parallel Seq Scan on questions  (cost=0.00..438117.00 rows=11516 width=12) (actual time=4150.200..5263.129 rows=9222 loops=3)
                                                        Filter: ((creationdate <= now()) AND (creationdate >= (now() - '6 mons'::interval)))
                                                        Rows Removed by Filter: 990778
                                ->  Sort  (cost=479290.57..479359.42 rows=27538 width=12) (actual time=5570.485..5578.808 rows=27916 loops=1)
                                      Sort Key: answers.owneruserid
                                      Sort Method: quicksort  Memory: 1826kB
                                      ->  Gather  (cost=1000.00..477259.77 rows=27538 width=12) (actual time=1117.642..5559.817 rows=27082 loops=1)
                                            Workers Planned: 2
                                            Workers Launched: 2
                                            ->  Parallel Seq Scan on answers  (cost=0.00..473505.97 rows=11474 width=12) (actual time=824.981..5499.368 rows=9027 loops=3)
                                                  Filter: ((creationdate <= now()) AND (creationdate >= (now() - '6 mons'::interval)))
                                                  Rows Removed by Filter: 1466740
                          ->  Sort  (cost=452301.20..452524.59 rows=89356 width=12) (actual time=5301.149..5365.319 rows=377341 loops=1)
                                Sort Key: comments.userid
                                Sort Method: external sort  Disk: 2496kB
                                ->  Gather  (cost=1000.00..444952.89 rows=89356 width=12) (actual time=4517.583..5240.883 rows=84794 loops=1)
                                      Workers Planned: 2
                                      Workers Launched: 2
                                      ->  Parallel Seq Scan on comments  (cost=0.00..435017.29 rows=37232 width=12) (actual time=4483.299..4984.116 rows=28265 loops=3)
                                            Filter: ((creationdate <= now()) AND (creationdate >= (now() - '6 mons'::interval)))
                                            Rows Removed by Filter: 3719337
Planning Time: 19.382 ms
Execution Time: 23825.663 ms


## indices no owneruserid & creationdate

apenas utilizou creationdate
depois de eliminar indices oweruserid, como o esperado, o plano permaneceu o mesmo

Limit  (cost=271529.86..271530.11 rows=100 width=22) (actual time=7942.691..7942.712 rows=100 loops=1)
  ->  Sort  (cost=271529.86..275261.60 rows=1492696 width=22) (actual time=7942.689..7942.699 rows=100 loops=1)
        Sort Key: (((count(DISTINCT questions.id) + count(DISTINCT answers.id)) + count(DISTINCT comments.id))) DESC
        Sort Method: top-N heapsort  Memory: 32kB
        ->  GroupAggregate  (cost=25616.07..214480.09 rows=1492696 width=22) (actual time=374.240..7530.835 rows=1492696 loops=1)
              Group Key: u.id
              ->  Incremental Sort  (cost=25616.07..177162.69 rows=1492696 width=26) (actual time=367.399..3085.418 rows=1838846 loops=1)
"                    Sort Key: u.id, questions.id"
                    Presorted Key: u.id
                    Full-sort Groups: 47996  Sort Method: quicksort  Average Memory: 28kB  Peak Memory: 28kB
                    Pre-sorted Groups: 10991  Sort Method: quicksort  Average Memory: 879kB  Peak Memory: 1155kB
                    ->  Merge Left Join  (cost=25616.00..109991.37 rows=1492696 width=26) (actual time=366.760..2465.741 rows=1838846 loops=1)
                          Merge Cond: (u.id = comments.userid)
                          ->  Merge Left Join  (cost=12490.41..91800.78 rows=1492696 width=22) (actual time=224.815..1857.163 rows=1502375 loops=1)
                                Merge Cond: (u.id = answers.owneruserid)
                                ->  Merge Left Join  (cost=6799.01..81962.31 rows=1492696 width=18) (actual time=153.118..1478.116 rows=1494699 loops=1)
                                      Merge Cond: (u.id = questions.owneruserid)
                                      ->  Index Scan using users_pkey on users u  (cost=0.43..71021.55 rows=1492696 width=14) (actual time=0.358..907.558 rows=1492696 loops=1)
                                      ->  Sort  (cost=6798.58..6868.48 rows=27959 width=12) (actual time=152.748..160.599 rows=27624 loops=1)
                                            Sort Key: questions.owneruserid
                                            Sort Method: quicksort  Memory: 1849kB
                                            ->  Index Scan using questions_creationdate_idx on questions  (cost=0.44..4733.66 rows=27959 width=12) (actual time=0.536..139.485 rows=27677 loops=1)
                                                  Index Cond: ((creationdate >= (now() - '6 mons'::interval)) AND (creationdate <= now()))
                                ->  Sort  (cost=5691.40..5761.45 rows=28021 width=12) (actual time=71.675..80.294 rows=27922 loops=1)
                                      Sort Key: answers.owneruserid
                                      Sort Method: quicksort  Memory: 1826kB
                                      ->  Index Scan using answers_creationdate_idx on answers  (cost=0.44..3621.46 rows=28021 width=12) (actual time=0.230..62.003 rows=27088 loops=1)
                                            Index Cond: ((creationdate >= (now() - '6 mons'::interval)) AND (creationdate <= now()))
                          ->  Sort  (cost=13125.14..13351.58 rows=90575 width=12) (actual time=141.915..206.615 rows=377597 loops=1)
                                Sort Key: comments.userid
                                Sort Method: external sort  Disk: 2496kB
                                ->  Index Scan using comments_creationdate_idx on comments  (cost=0.44..5667.73 rows=90575 width=12) (actual time=0.237..81.513 rows=84827 loops=1)
                                      Index Cond: ((creationdate >= (now() - '6 mons'::interval)) AND (creationdate <= now()))
Planning Time: 41.599 ms
Execution Time: 7945.915 ms

## creationdate clustered idx

Limit  (cost=271768.15..271768.40 rows=100 width=22) (actual time=9354.453..9354.476 rows=100 loops=1)
  ->  Sort  (cost=271768.15..275499.89 rows=1492696 width=22) (actual time=9354.451..9354.462 rows=100 loops=1)
        Sort Key: (((count(DISTINCT questions.id) + count(DISTINCT answers.id)) + count(DISTINCT comments.id))) DESC
        Sort Method: top-N heapsort  Memory: 32kB
        ->  GroupAggregate  (cost=25763.32..214718.38 rows=1492696 width=22) (actual time=354.548..8859.906 rows=1492696 loops=1)
              Group Key: u.id
              ->  Incremental Sort  (cost=25763.32..177400.98 rows=1492696 width=26) (actual time=354.079..3522.654 rows=1838532 loops=1)
"                    Sort Key: u.id, questions.id"
                    Presorted Key: u.id
                    Full-sort Groups: 47995  Sort Method: quicksort  Average Memory: 28kB  Peak Memory: 28kB
                    Pre-sorted Groups: 10953  Sort Method: quicksort  Average Memory: 879kB  Peak Memory: 1155kB
                    ->  Merge Left Join  (cost=25763.26..110229.66 rows=1492696 width=26) (actual time=353.525..2799.978 rows=1838532 loops=1)
                          Merge Cond: (u.id = comments.userid)
                          ->  Merge Left Join  (cost=12626.17..92028.39 rows=1492696 width=22) (actual time=184.753..2105.693 rows=1502366 loops=1)
                                Merge Cond: (u.id = answers.owneruserid)
                                ->  Merge Left Join  (cost=6874.38..82129.78 rows=1492696 width=18) (actual time=114.617..1683.549 rows=1494696 loops=1)
                                      Merge Cond: (u.id = questions.owneruserid)
                                      ->  Index Scan using users_pkey on users u  (cost=0.43..71113.92 rows=1492696 width=14) (actual time=0.072..1093.469 rows=1492696 loops=1)
                                      ->  Sort  (cost=6873.93..6943.79 rows=27943 width=12) (actual time=114.535..122.778 rows=27611 loops=1)
                                            Sort Key: questions.owneruserid
                                            Sort Method: quicksort  Memory: 1849kB
                                            ->  Index Scan using questions_creationdate_idx on questions  (cost=0.44..4810.32 rows=27943 width=12) (actual time=5.922..100.306 rows=27664 loops=1)
                                                  Index Cond: ((creationdate >= (now() - '6 mons'::interval)) AND (creationdate <= now()))
                                ->  Sort  (cost=5751.77..5821.79 rows=28005 width=12) (actual time=70.128..79.601 rows=27912 loops=1)
                                      Sort Key: answers.owneruserid
                                      Sort Method: quicksort  Memory: 1826kB
                                      ->  Index Scan using answers_creationdate_idx on answers  (cost=0.44..3683.13 rows=28005 width=12) (actual time=0.168..59.888 rows=27078 loops=1)
                                            Index Cond: ((creationdate >= (now() - '6 mons'::interval)) AND (creationdate <= now()))
                          ->  Sort  (cost=13136.61..13362.92 rows=90524 width=12) (actual time=168.759..242.286 rows=377274 loops=1)
                                Sort Key: comments.userid
                                Sort Method: external sort  Disk: 2496kB
                                ->  Index Scan using comments_creationdate_idx on comments  (cost=0.44..5683.76 rows=90524 width=12) (actual time=0.171..97.804 rows=84777 loops=1)
                                      Index Cond: ((creationdate >= (now() - '6 mons'::interval)) AND (creationdate <= now()))
Planning Time: 20.967 ms
Execution Time: 9357.764 ms


# Q1_V1 

## sem Ã­ndice

Limit  (cost=1491323.61..1491323.86 rows=100 width=22) (actual time=19247.423..19247.623 rows=100 loops=1)
  ->  Sort  (cost=1491323.61..1495055.35 rows=1492696 width=22) (actual time=19247.420..19247.610 rows=100 loops=1)
"        Sort Key: (((COALESCE(q.q_total, '0'::bigint) + COALESCE(a.a_total, '0'::bigint)) + COALESCE(c.c_total, '0'::bigint))) DESC"
        Sort Method: top-N heapsort  Memory: 32kB
        ->  Hash Left Join  (cost=1374968.39..1434273.85 rows=1492696 width=22) (actual time=16187.717..18800.852 rows=1492696 loops=1)
              Hash Cond: (u.id = c.userid)
              ->  Hash Left Join  (cost=923523.32..971446.96 rows=1492696 width=30) (actual time=11019.849..12938.177 rows=1492696 loops=1)
                    Hash Cond: (u.id = a.owneruserid)
                    ->  Hash Left Join  (cost=444122.01..488127.31 rows=1492696 width=22) (actual time=5360.582..6747.268 rows=1492696 loops=1)
                          Hash Cond: (u.id = q.owneruserid)
                          ->  Seq Scan on users u  (cost=0.00..40086.96 rows=1492696 width=14) (actual time=4.521..655.164 rows=1492696 loops=1)
                          ->  Hash  (cost=443786.91..443786.91 rows=26808 width=16) (actual time=5355.847..5355.934 rows=25611 loops=1)
                                Buckets: 32768  Batches: 1  Memory Usage: 1457kB
                                ->  Subquery Scan on q  (cost=439893.78..443786.91 rows=26808 width=16) (actual time=5329.378..5350.173 rows=25612 loops=1)
                                      ->  GroupAggregate  (cost=439893.78..443518.83 rows=26808 width=16) (actual time=5329.375..5346.786 rows=25612 loops=1)
                                            Group Key: questions.owneruserid
                                            ->  Gather Merge  (cost=439893.78..443112.56 rows=27637 width=12) (actual time=5329.362..5336.925 rows=27665 loops=1)
                                                  Workers Planned: 2
                                                  Workers Launched: 2
                                                  ->  Sort  (cost=438893.76..438922.54 rows=11515 width=12) (actual time=5263.121..5264.451 rows=9222 loops=3)
"                                                        Sort Key: questions.owneruserid, questions.id"
                                                        Sort Method: quicksort  Memory: 750kB
                                                        Worker 0:  Sort Method: quicksort  Memory: 749kB
                                                        Worker 1:  Sort Method: quicksort  Memory: 735kB
                                                        ->  Parallel Seq Scan on questions  (cost=0.00..438117.00 rows=11515 width=12) (actual time=4035.289..5255.899 rows=9222 loops=3)
                                                              Filter: ((creationdate <= now()) AND (creationdate >= (now() - '6 mons'::interval)))
                                                              Rows Removed by Filter: 990778
                    ->  Hash  (cost=479102.59..479102.59 rows=23898 width=16) (actual time=5659.050..5659.097 rows=17913 loops=1)
                          Buckets: 32768  Batches: 1  Memory Usage: 1096kB
                          ->  Subquery Scan on a  (cost=475279.69..479102.59 rows=23898 width=16) (actual time=5626.795..5652.803 rows=17914 loops=1)
                                ->  GroupAggregate  (cost=475279.69..478863.61 rows=23898 width=16) (actual time=5626.793..5649.885 rows=17914 loops=1)
                                      Group Key: answers.owneruserid
                                      ->  Gather Merge  (cost=475279.69..478486.94 rows=27538 width=12) (actual time=5626.784..5637.606 rows=27082 loops=1)
                                            Workers Planned: 2
                                            Workers Launched: 2
                                            ->  Sort  (cost=474279.66..474308.35 rows=11474 width=12) (actual time=5573.363..5574.705 rows=9027 loops=3)
"                                                  Sort Key: answers.owneruserid, answers.id"
                                                  Sort Method: quicksort  Memory: 738kB
                                                  Worker 0:  Sort Method: quicksort  Memory: 734kB
                                                  Worker 1:  Sort Method: quicksort  Memory: 739kB
                                                  ->  Parallel Seq Scan on answers  (cost=0.00..473505.97 rows=11474 width=12) (actual time=845.936..5567.690 rows=9027 loops=3)
                                                        Filter: ((creationdate <= now()) AND (creationdate >= (now() - '6 mons'::interval)))
                                                        Rows Removed by Filter: 1466740
              ->  Hash  (cost=450772.91..450772.91 rows=53773 width=16) (actual time=5167.523..5167.568 rows=28054 loops=1)
                    Buckets: 65536  Batches: 1  Memory Usage: 1828kB
                    ->  Subquery Scan on c  (cost=438843.93..450772.91 rows=53773 width=16) (actual time=5106.894..5159.189 rows=28055 loops=1)
                          ->  GroupAggregate  (cost=438843.93..450235.18 rows=53773 width=16) (actual time=5106.892..5155.280 rows=28055 loops=1)
                                Group Key: comments.userid
                                ->  Gather Merge  (cost=438843.93..449250.68 rows=89354 width=12) (actual time=5106.333..5133.617 rows=84792 loops=1)
                                      Workers Planned: 2
                                      Workers Launched: 2
                                      ->  Sort  (cost=437843.91..437936.98 rows=37231 width=12) (actual time=5022.022..5027.239 rows=28264 loops=3)
"                                            Sort Key: comments.userid, comments.id"
                                            Sort Method: quicksort  Memory: 1877kB
                                            Worker 0:  Sort Method: quicksort  Memory: 1860kB
                                            Worker 1:  Sort Method: quicksort  Memory: 1880kB
                                            ->  Parallel Seq Scan on comments  (cost=0.00..435017.29 rows=37231 width=12) (actual time=3192.696..5002.681 rows=28264 loops=3)
                                                  Filter: ((creationdate <= now()) AND (creationdate >= (now() - '6 mons'::interval)))
                                                  Rows Removed by Filter: 3719337
Planning Time: 13.981 ms
Execution Time: 19248.784 ms



## indices no owneruserid & creationdate
apenas utilizou creationdate
depois de eliminar indices oweruserid, como o esperado, o plano permaneceu o mesmo

Limit  (cost=94301.75..94313.41 rows=100 width=22) (actual time=1501.678..1519.992 rows=100 loops=1)
  ->  Gather Merge  (cost=94301.75..239435.18 rows=1243914 width=22) (actual time=1501.676..1519.978 rows=100 loops=1)
        Workers Planned: 2
        Workers Launched: 2
        ->  Sort  (cost=93301.72..94856.62 rows=621957 width=22) (actual time=1401.952..1401.969 rows=77 loops=3)
"              Sort Key: (((COALESCE(q.q_total, '0'::bigint) + COALESCE(a.a_total, '0'::bigint)) + COALESCE(c.c_total, '0'::bigint))) DESC"
              Sort Method: top-N heapsort  Memory: 32kB
              Worker 0:  Sort Method: top-N heapsort  Memory: 32kB
              Worker 1:  Sort Method: top-N heapsort  Memory: 31kB
              ->  Hash Left Join  (cost=30143.71..69530.97 rows=621957 width=22) (actual time=433.273..1258.611 rows=497565 loops=3)
                    Hash Cond: (u.id = c.userid)
                    ->  Hash Left Join  (cost=14579.07..49223.91 rows=621957 width=30) (actual time=206.348..804.600 rows=497565 loops=3)
                          Hash Cond: (u.id = a.owneruserid)
                          ->  Hash Left Join  (cost=7889.24..40901.44 rows=621957 width=22) (actual time=119.610..541.405 rows=497565 loops=3)
                                Hash Cond: (u.id = q.owneruserid)
                                ->  Parallel Seq Scan on users u  (cost=0.00..31379.57 rows=621957 width=14) (actual time=0.961..189.735 rows=497565 loops=3)
                                ->  Hash  (cost=7550.36..7550.36 rows=27110 width=16) (actual time=117.580..117.583 rows=25620 loops=3)
                                      Buckets: 32768  Batches: 1  Memory Usage: 1457kB
                                      ->  Subquery Scan on q  (cost=6798.48..7550.36 rows=27110 width=16) (actual time=85.662..110.575 rows=25621 loops=3)
                                            ->  GroupAggregate  (cost=6798.48..7279.26 rows=27110 width=16) (actual time=85.660..106.983 rows=25621 loops=3)
                                                  Group Key: questions.owneruserid
                                                  ->  Sort  (cost=6798.48..6868.37 rows=27958 width=12) (actual time=85.642..91.914 rows=27677 loops=3)
"                                                        Sort Key: questions.owneruserid, questions.id"
                                                        Sort Method: quicksort  Memory: 1849kB
                                                        Worker 0:  Sort Method: quicksort  Memory: 1849kB
                                                        Worker 1:  Sort Method: quicksort  Memory: 1849kB
                                                        ->  Index Scan using questions_creationdate_idx on questions  (cost=0.44..4733.64 rows=27958 width=12) (actual time=0.116..71.574 rows=27677 loops=3)
                                                              Index Cond: ((creationdate >= (now() - '6 mons'::interval)) AND (creationdate <= now()))
                          ->  Hash  (cost=6386.61..6386.61 rows=24258 width=16) (actual time=86.477..86.479 rows=17914 loops=3)
                                Buckets: 32768  Batches: 1  Memory Usage: 1096kB
                                ->  Subquery Scan on a  (cost=5691.30..6386.61 rows=24258 width=16) (actual time=65.188..82.146 rows=17915 loops=3)
                                      ->  GroupAggregate  (cost=5691.30..6144.03 rows=24258 width=16) (actual time=65.187..79.890 rows=17915 loops=3)
                                            Group Key: answers.owneruserid
                                            ->  Sort  (cost=5691.30..5761.35 rows=28020 width=12) (actual time=65.167..70.007 rows=27088 loops=3)
"                                                  Sort Key: answers.owneruserid, answers.id"
                                                  Sort Method: quicksort  Memory: 1826kB
                                                  Worker 0:  Sort Method: quicksort  Memory: 1826kB
                                                  Worker 1:  Sort Method: quicksort  Memory: 1826kB
                                                  ->  Index Scan using answers_creationdate_idx on answers  (cost=0.44..3621.44 rows=28020 width=12) (actual time=0.198..52.047 rows=27088 loops=3)
                                                        Index Cond: ((creationdate >= (now() - '6 mons'::interval)) AND (creationdate <= now()))
                    ->  Hash  (cost=14887.56..14887.56 rows=54167 width=16) (actual time=226.506..226.508 rows=28058 loops=3)
                          Buckets: 65536  Batches: 1  Memory Usage: 1828kB
                          ->  Subquery Scan on c  (cost=13124.92..14887.56 rows=54167 width=16) (actual time=165.564..218.663 rows=28059 loops=3)
                                ->  GroupAggregate  (cost=13124.92..14345.89 rows=54167 width=16) (actual time=165.563..214.727 rows=28059 loops=3)
                                      Group Key: comments.userid
                                      ->  Sort  (cost=13124.92..13351.35 rows=90573 width=12) (actual time=165.256..187.118 rows=84826 loops=3)
"                                            Sort Key: comments.userid, comments.id"
                                            Sort Method: external merge  Disk: 1832kB
                                            Worker 0:  Sort Method: external merge  Disk: 1832kB
                                            Worker 1:  Sort Method: external merge  Disk: 1832kB
                                            ->  Index Scan using comments_creationdate_idx on comments  (cost=0.44..5667.68 rows=90573 width=12) (actual time=0.207..103.020 rows=84826 loops=3)
                                                  Index Cond: ((creationdate >= (now() - '6 mons'::interval)) AND (creationdate <= now()))
Planning Time: 30.676 ms
Execution Time: 1523.253 ms


## creationdate clustered idx

Limit  (cost=94444.93..94456.59 rows=100 width=22) (actual time=1391.225..1409.303 rows=100 loops=1)
  ->  Gather Merge  (cost=94444.93..239578.36 rows=1243914 width=22) (actual time=1391.223..1409.288 rows=100 loops=1)
        Workers Planned: 2
        Workers Launched: 2
        ->  Sort  (cost=93444.90..94999.80 rows=621957 width=22) (actual time=1315.412..1315.428 rows=74 loops=3)
"              Sort Key: (((COALESCE(q.q_total, '0'::bigint) + COALESCE(a.a_total, '0'::bigint)) + COALESCE(c.c_total, '0'::bigint))) DESC"
              Sort Method: top-N heapsort  Memory: 31kB
              Worker 0:  Sort Method: top-N heapsort  Memory: 31kB
              Worker 1:  Sort Method: top-N heapsort  Memory: 32kB
              ->  Hash Left Join  (cost=30286.89..69674.15 rows=621957 width=22) (actual time=376.695..1181.183 rows=497565 loops=3)
                    Hash Cond: (u.id = c.userid)
                    ->  Hash Left Join  (cost=14712.68..49357.52 rows=621957 width=30) (actual time=184.047..767.963 rows=497565 loops=3)
                          Hash Cond: (u.id = a.owneruserid)
                          ->  Hash Left Join  (cost=7963.98..40976.19 rows=621957 width=22) (actual time=104.733..517.702 rows=497565 loops=3)
                                Hash Cond: (u.id = q.owneruserid)
                                ->  Parallel Seq Scan on users u  (cost=0.00..31379.57 rows=621957 width=14) (actual time=0.713..185.653 rows=497565 loops=3)
                                ->  Hash  (cost=7625.30..7625.30 rows=27095 width=16) (actual time=103.757..103.759 rows=25609 loops=3)
                                      Buckets: 32768  Batches: 1  Memory Usage: 1457kB
                                      ->  Subquery Scan on q  (cost=6873.83..7625.30 rows=27095 width=16) (actual time=75.696..97.394 rows=25610 loops=3)
                                            ->  GroupAggregate  (cost=6873.83..7354.35 rows=27095 width=16) (actual time=75.694..94.088 rows=25610 loops=3)
                                                  Group Key: questions.owneruserid
                                                  ->  Sort  (cost=6873.83..6943.69 rows=27942 width=12) (actual time=75.677..81.702 rows=27663 loops=3)
"                                                        Sort Key: questions.owneruserid, questions.id"
                                                        Sort Method: quicksort  Memory: 1849kB
                                                        Worker 0:  Sort Method: quicksort  Memory: 1849kB
                                                        Worker 1:  Sort Method: quicksort  Memory: 1849kB
                                                        ->  Index Scan using questions_creationdate_idx on questions  (cost=0.44..4810.29 rows=27942 width=12) (actual time=0.152..62.910 rows=27663 loops=3)
                                                              Index Cond: ((creationdate >= (now() - '6 mons'::interval)) AND (creationdate <= now()))
                          ->  Hash  (cost=6445.62..6445.62 rows=24246 width=16) (actual time=79.074..79.076 rows=17910 loops=3)
                                Buckets: 32768  Batches: 1  Memory Usage: 1096kB
                                ->  Subquery Scan on a  (cost=5750.67..6445.62 rows=24246 width=16) (actual time=56.578..74.559 rows=17911 loops=3)
                                      ->  GroupAggregate  (cost=5750.67..6203.16 rows=24246 width=16) (actual time=56.576..72.204 rows=17911 loops=3)
                                            Group Key: answers.owneruserid
                                            ->  Sort  (cost=5750.67..5820.68 rows=28004 width=12) (actual time=56.562..61.640 rows=27078 loops=3)
"                                                  Sort Key: answers.owneruserid, answers.id"
                                                  Sort Method: quicksort  Memory: 1826kB
                                                  Worker 0:  Sort Method: quicksort  Memory: 1826kB
                                                  Worker 1:  Sort Method: quicksort  Memory: 1826kB
                                                  ->  Index Scan using answers_creationdate_idx on answers  (cost=0.44..3682.11 rows=28004 width=12) (actual time=0.144..44.232 rows=27078 loops=3)
                                                        Index Cond: ((creationdate >= (now() - '6 mons'::interval)) AND (creationdate <= now()))
                    ->  Hash  (cost=14897.32..14897.32 rows=54151 width=16) (actual time=192.224..192.226 rows=28048 loops=3)
                          Buckets: 65536  Batches: 1  Memory Usage: 1827kB
                          ->  Subquery Scan on c  (cost=13135.39..14897.32 rows=54151 width=16) (actual time=147.815..185.034 rows=28049 loops=3)
                                ->  GroupAggregate  (cost=13135.39..14355.81 rows=54151 width=16) (actual time=147.813..181.400 rows=28049 loops=3)
                                      Group Key: comments.userid
                                      ->  Sort  (cost=13135.39..13361.69 rows=90522 width=12) (actual time=147.528..159.006 rows=84775 loops=3)
"                                            Sort Key: comments.userid, comments.id"
                                            Sort Method: external merge  Disk: 1832kB
                                            Worker 0:  Sort Method: external merge  Disk: 1832kB
                                            Worker 1:  Sort Method: external merge  Disk: 1832kB
                                            ->  Index Scan using comments_creationdate_idx on comments  (cost=0.44..5682.72 rows=90522 width=12) (actual time=0.173..86.505 rows=84775 loops=3)
                                                  Index Cond: ((creationdate >= (now() - '6 mons'::interval)) AND (creationdate <= now()))
Planning Time: 33.192 ms
Execution Time: 1413.183 ms


# Q1_V2

## sem Ã­ndice

Limit  (cost=1527576.93..1527577.18 rows=100 width=46) (actual time=19535.730..19535.888 rows=100 loops=1)
  ->  Sort  (cost=1527576.93..1531308.67 rows=1492696 width=46) (actual time=19535.728..19535.875 rows=100 loops=1)
"        Sort Key: (sum(COALESCE(""*SELECT* 1"".total, '0'::bigint))) DESC"
        Sort Method: top-N heapsort  Memory: 31kB
        ->  GroupAggregate  (cost=1354017.76..1470527.16 rows=1492696 width=46) (actual time=15791.819..18999.936 rows=1492696 loops=1)
              Group Key: u.id
              ->  Merge Left Join  (cost=1354017.76..1444404.98 rows=1492696 width=22) (actual time=15791.796..17486.362 rows=1510061 loops=1)
"                    Merge Cond: (u.id = ""*SELECT* 1"".user_id)"
                    ->  Index Scan using users_pkey on users u  (cost=0.43..64093.51 rows=1492696 width=14) (actual time=0.110..1055.867 rows=1492696 loops=1)
                    ->  Materialize  (cost=1354017.34..1375273.76 rows=104478 width=16) (actual time=15791.679..15971.441 rows=71579 loops=1)
                          ->  Merge Append  (cost=1354017.34..1375012.56 rows=104478 width=16) (actual time=15791.674..15946.546 rows=71579 loops=1)
"                                Sort Key: ""*SELECT* 1"".user_id"
"                                ->  Subquery Scan on ""*SELECT* 1""  (cost=439893.78..443786.91 rows=26808 width=16) (actual time=5225.980..5260.236 rows=25612 loops=1)"
                                      ->  GroupAggregate  (cost=439893.78..443518.83 rows=26808 width=16) (actual time=5225.978..5255.659 rows=25612 loops=1)
                                            Group Key: questions.owneruserid
                                            ->  Gather Merge  (cost=439893.78..443112.56 rows=27637 width=12) (actual time=5225.968..5239.085 rows=27665 loops=1)
                                                  Workers Planned: 2
                                                  Workers Launched: 2
                                                  ->  Sort  (cost=438893.76..438922.54 rows=11515 width=12) (actual time=5157.985..5160.149 rows=9222 loops=3)
"                                                        Sort Key: questions.owneruserid, questions.id"
                                                        Sort Method: quicksort  Memory: 740kB
                                                        Worker 0:  Sort Method: quicksort  Memory: 746kB
                                                        Worker 1:  Sort Method: quicksort  Memory: 747kB
                                                        ->  Parallel Seq Scan on questions  (cost=0.00..438117.00 rows=11515 width=12) (actual time=3982.971..5151.924 rows=9222 loops=3)
                                                              Filter: ((creationdate <= now()) AND (creationdate >= (now() - '6 mons'::interval)))
                                                              Rows Removed by Filter: 990778
"                                ->  Subquery Scan on ""*SELECT* 2""  (cost=475279.69..479102.59 rows=23898 width=16) (actual time=5561.726..5593.365 rows=17914 loops=1)"
                                      ->  GroupAggregate  (cost=475279.69..478863.61 rows=23898 width=16) (actual time=5561.724..5589.948 rows=17914 loops=1)
                                            Group Key: answers.owneruserid
                                            ->  Gather Merge  (cost=475279.69..478486.94 rows=27538 width=12) (actual time=5561.714..5575.284 rows=27082 loops=1)
                                                  Workers Planned: 2
                                                  Workers Launched: 2
                                                  ->  Sort  (cost=474279.66..474308.35 rows=11474 width=12) (actual time=5500.937..5503.219 rows=9027 loops=3)
"                                                        Sort Key: answers.owneruserid, answers.id"
                                                        Sort Method: quicksort  Memory: 739kB
                                                        Worker 0:  Sort Method: quicksort  Memory: 742kB
                                                        Worker 1:  Sort Method: quicksort  Memory: 731kB
                                                        ->  Parallel Seq Scan on answers  (cost=0.00..473505.97 rows=11474 width=12) (actual time=857.103..5495.337 rows=9027 loops=3)
                                                              Filter: ((creationdate <= now()) AND (creationdate >= (now() - '6 mons'::interval)))
                                                              Rows Removed by Filter: 1466740
"                                ->  Subquery Scan on ""*SELECT* 3""  (cost=438843.85..450772.68 rows=53772 width=16) (actual time=5003.963..5074.854 rows=28055 loops=1)"
                                      ->  GroupAggregate  (cost=438843.85..450234.96 rows=53772 width=16) (actual time=5003.961..5069.530 rows=28055 loops=1)
                                            Group Key: comments.userid
                                            ->  Gather Merge  (cost=438843.85..449250.47 rows=89353 width=12) (actual time=5003.505..5040.720 rows=84790 loops=1)
                                                  Workers Planned: 2
                                                  Workers Launched: 2
                                                  ->  Sort  (cost=437843.82..437936.90 rows=37230 width=12) (actual time=4945.580..4952.293 rows=28263 loops=3)
"                                                        Sort Key: comments.userid, comments.id"
                                                        Sort Method: quicksort  Memory: 1897kB
                                                        Worker 0:  Sort Method: quicksort  Memory: 1861kB
                                                        Worker 1:  Sort Method: quicksort  Memory: 1859kB
                                                        ->  Parallel Seq Scan on comments  (cost=0.00..435017.29 rows=37230 width=12) (actual time=3164.917..4927.550 rows=28263 loops=3)
                                                              Filter: ((creationdate <= now()) AND (creationdate >= (now() - '6 mons'::interval)))
                                                              Rows Removed by Filter: 3719338
Planning Time: 26.432 ms
Execution Time: 19536.636 ms


## indices no owneruserid & creationdate
apenas utilizou creationdate
depois de eliminar indices oweruserid, como o esperado, o plano permaneceu o mesmo

Limit  (cost=182768.79..182769.04 rows=100 width=46) (actual time=3900.334..3900.359 rows=100 loops=1)
  ->  Sort  (cost=182768.79..186500.53 rows=1492696 width=46) (actual time=3900.332..3900.345 rows=100 loops=1)
"        Sort Key: (sum(COALESCE(""*SELECT* 1"".total, '0'::bigint))) DESC"
        Sort Method: top-N heapsort  Memory: 31kB
        ->  GroupAggregate  (cost=25615.14..125719.02 rows=1492696 width=46) (actual time=192.482..3351.952 rows=1492696 loops=1)
              Group Key: u.id
              ->  Merge Left Join  (cost=25615.14..99596.84 rows=1492696 width=22) (actual time=192.450..1751.141 rows=1510066 loops=1)
"                    Merge Cond: (u.id = ""*SELECT* 1"".user_id)"
                    ->  Index Scan using users_pkey on users u  (cost=0.43..64093.51 rows=1492696 width=14) (actual time=8.183..929.692 rows=1492696 loops=1)
                    ->  Materialize  (cost=25614.71..30452.40 rows=105535 width=16) (actual time=184.251..348.336 rows=71593 loops=1)
                          ->  Merge Append  (cost=25614.71..30188.57 rows=105535 width=16) (actual time=184.238..325.744 rows=71593 loops=1)
"                                Sort Key: ""*SELECT* 1"".user_id"
"                                ->  Subquery Scan on ""*SELECT* 1""  (cost=6798.48..7550.36 rows=27110 width=16) (actual time=33.738..66.998 rows=25621 loops=1)"
                                      ->  GroupAggregate  (cost=6798.48..7279.26 rows=27110 width=16) (actual time=33.736..62.252 rows=25621 loops=1)
                                            Group Key: questions.owneruserid
                                            ->  Sort  (cost=6798.48..6868.37 rows=27958 width=12) (actual time=33.721..42.124 rows=27677 loops=1)
"                                                  Sort Key: questions.owneruserid, questions.id"
                                                  Sort Method: quicksort  Memory: 1849kB
                                                  ->  Index Scan using questions_creationdate_idx on questions  (cost=0.44..4733.64 rows=27958 width=12) (actual time=0.080..22.987 rows=27677 loops=1)
                                                        Index Cond: ((creationdate >= (now() - '6 mons'::interval)) AND (creationdate <= now()))
"                                ->  Subquery Scan on ""*SELECT* 2""  (cost=5691.30..6386.61 rows=24258 width=16) (actual time=34.384..63.827 rows=17915 loops=1)"
                                      ->  GroupAggregate  (cost=5691.30..6144.03 rows=24258 width=16) (actual time=34.382..60.338 rows=17915 loops=1)
                                            Group Key: answers.owneruserid
                                            ->  Sort  (cost=5691.30..5761.35 rows=28020 width=12) (actual time=34.368..42.647 rows=27088 loops=1)
"                                                  Sort Key: answers.owneruserid, answers.id"
                                                  Sort Method: quicksort  Memory: 1826kB
                                                  ->  Index Scan using answers_creationdate_idx on answers  (cost=0.44..3621.44 rows=28020 width=12) (actual time=0.072..22.642 rows=27088 loops=1)
                                                        Index Cond: ((creationdate >= (now() - '6 mons'::interval)) AND (creationdate <= now()))
"                                ->  Subquery Scan on ""*SELECT* 3""  (cost=13124.92..14887.56 rows=54167 width=16) (actual time=116.106..175.705 rows=28059 loops=1)"
                                      ->  GroupAggregate  (cost=13124.92..14345.89 rows=54167 width=16) (actual time=116.103..170.172 rows=28059 loops=1)
                                            Group Key: comments.userid
                                            ->  Sort  (cost=13124.92..13351.35 rows=90573 width=12) (actual time=115.633..135.528 rows=84826 loops=1)
"                                                  Sort Key: comments.userid, comments.id"
                                                  Sort Method: external merge  Disk: 1832kB
                                                  ->  Index Scan using comments_creationdate_idx on comments  (cost=0.44..5667.68 rows=90573 width=12) (actual time=0.079..53.810 rows=84826 loops=1)
                                                        Index Cond: ((creationdate >= (now() - '6 mons'::interval)) AND (creationdate <= now()))
Planning Time: 30.757 ms
Execution Time: 3903.467 ms


## creationdate clustered idx

Limit  (cost=182910.30..182910.55 rows=100 width=46) (actual time=3728.444..3728.465 rows=100 loops=1)
  ->  Sort  (cost=182910.30..186642.04 rows=1492696 width=46) (actual time=3728.441..3728.451 rows=100 loops=1)
"        Sort Key: (sum(COALESCE(""*SELECT* 1"".total, '0'::bigint))) DESC"
        Sort Method: top-N heapsort  Memory: 31kB
        ->  GroupAggregate  (cost=25759.58..125860.53 rows=1492696 width=46) (actual time=325.804..3210.558 rows=1492696 loops=1)
              Group Key: u.id
              ->  Merge Left Join  (cost=25759.58..99738.35 rows=1492696 width=22) (actual time=325.779..1745.978 rows=1510059 loops=1)
"                    Merge Cond: (u.id = ""*SELECT* 1"".user_id)"
                    ->  Index Scan using users_pkey on users u  (cost=0.43..64093.51 rows=1492696 width=14) (actual time=0.172..831.490 rows=1492696 loops=1)
                    ->  Materialize  (cost=25759.15..30594.50 rows=105488 width=16) (actual time=325.598..472.091 rows=71566 loops=1)
                          ->  Merge Append  (cost=25759.15..30330.78 rows=105488 width=16) (actual time=325.591..451.487 rows=71566 loops=1)
"                                Sort Key: ""*SELECT* 1"".user_id"
"                                ->  Subquery Scan on ""*SELECT* 1""  (cost=6873.73..7625.17 rows=27094 width=16) (actual time=119.885..149.791 rows=25609 loops=1)"
                                      ->  GroupAggregate  (cost=6873.73..7354.23 rows=27094 width=16) (actual time=119.883..145.790 rows=25609 loops=1)
                                            Group Key: questions.owneruserid
                                            ->  Sort  (cost=6873.73..6943.58 rows=27941 width=12) (actual time=119.867..127.489 rows=27662 loops=1)
"                                                  Sort Key: questions.owneruserid, questions.id"
                                                  Sort Method: quicksort  Memory: 1849kB
                                                  ->  Index Scan using questions_creationdate_idx on questions  (cost=0.44..4810.27 rows=27941 width=12) (actual time=0.373..104.349 rows=27662 loops=1)
                                                        Index Cond: ((creationdate >= (now() - '6 mons'::interval)) AND (creationdate <= now()))
"                                ->  Subquery Scan on ""*SELECT* 2""  (cost=5750.57..6445.49 rows=24245 width=16) (actual time=72.505..99.369 rows=17910 loops=1)"
                                      ->  GroupAggregate  (cost=5750.57..6203.04 rows=24245 width=16) (actual time=72.502..96.330 rows=17910 loops=1)
                                            Group Key: answers.owneruserid
                                            ->  Sort  (cost=5750.57..5820.58 rows=28003 width=12) (actual time=72.487..80.309 rows=27075 loops=1)
"                                                  Sort Key: answers.owneruserid, answers.id"
                                                  Sort Method: quicksort  Memory: 1826kB
                                                  ->  Index Scan using answers_creationdate_idx on answers  (cost=0.44..3682.09 rows=28003 width=12) (actual time=0.116..59.867 rows=27075 loops=1)
                                                        Index Cond: ((creationdate >= (now() - '6 mons'::interval)) AND (creationdate <= now()))
"                                ->  Subquery Scan on ""*SELECT* 3""  (cost=13134.83..14896.69 rows=54149 width=16) (actual time=133.193..185.639 rows=28049 loops=1)"
                                      ->  GroupAggregate  (cost=13134.83..14355.20 rows=54149 width=16) (actual time=133.191..180.968 rows=28049 loops=1)
                                            Group Key: comments.userid
                                            ->  Sort  (cost=13134.83..13361.12 rows=90517 width=12) (actual time=132.904..150.384 rows=84774 loops=1)
"                                                  Sort Key: comments.userid, comments.id"
                                                  Sort Method: external merge  Disk: 1832kB
                                                  ->  Index Scan using comments_creationdate_idx on comments  (cost=0.44..5682.61 rows=90517 width=12) (actual time=0.446..79.925 rows=84774 loops=1)
                                                        Index Cond: ((creationdate >= (now() - '6 mons'::interval)) AND (creationdate <= now()))
Planning Time: 20.926 ms
Execution Time: 3731.546 ms
